<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMOKEY Wildfire Dashboard (1991-2015)</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- PapaParse -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b35;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
    </style>
</head>
<body class="p-4">
    <!-- Loading Screen -->
    <div id="loading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
        <div class="loading-spinner mb-4"></div>
        <h2 class="text-2xl font-bold text-gray-700" id="loading-text">Loading wildfire data...</h2>
        <p class="text-gray-500 mt-2" id="loading-progress">Initializing...</p>
    </div>

    <!-- Main Dashboard (hidden until loaded) -->
    <div id="dashboard" class="hidden">
        <header class="text-center mb-8" role="banner">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üî• SMOKEY Wildfire Dashboard</h1>
            <p class="text-gray-600">Exploring U.S. Wildfire Patterns (1991-2015)</p>
            <p class="text-sm text-gray-500 mt-2">
                Interactive data visualization for educators and the public
            </p>
        </header>

        <!-- Filter Bar -->
        <div id="filters" class="bg-white rounded-lg shadow-md p-6 mb-6 sticky top-4 z-40">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- Geography Filters -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìç State</label>
                    <select id="filter-state" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" aria-label="Filter by state">
                        <option value="all">All States</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üó∫Ô∏è Region</label>
                    <select id="filter-region" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" aria-label="Filter by region">
                        <option value="all">All Regions</option>
                        <option value="West">West</option>
                        <option value="Midwest">Midwest</option>
                        <option value="South">South</option>
                        <option value="Northeast">Northeast</option>
                    </select>
                </div>

                <!-- Year Range -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        üìÖ Year Range: <span id="year-range-label">1991 - 2015</span>
                    </label>
                    <div class="px-2">
                        <input type="range" id="filter-year-min" min="1991" max="2015" value="1991"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" aria-label="Minimum year">
                        <input type="range" id="filter-year-max" min="1991" max="2015" value="2015"
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-1" aria-label="Maximum year">
                    </div>
                </div>

                <!-- Fire Cause (placeholder) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üî• Cause</label>
                    <select id="filter-cause" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" aria-label="Filter by fire cause">
                        <option value="all">All Causes</option>
                    </select>
                </div>

                <!-- Fire Size Class -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìè Size</label>
                    <select id="filter-size" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" aria-label="Filter by fire size class">
                        <option value="all">All Sizes</option>
                    </select>
                </div>
            </div>

            <!-- Filter Summary -->
            <div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">
                <div id="filter-summary" class="text-sm text-gray-600">
                    Showing: <span id="record-count" class="font-bold text-blue-600">0</span> fires
                </div>
                <button id="reset-filters" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-md text-sm font-semibold" aria-label="Reset all filters to default">
                    Reset All Filters
                </button>
            </div>
        </div>

        <!-- Educational Info Panels -->
        <div class="mb-6 space-y-3">
            <!-- About This Data -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button onclick="togglePanel('about-panel')" class="w-full px-6 py-3 text-left font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center">
                    <span>‚ÑπÔ∏è About This Data</span>
                    <span id="about-icon" class="text-gray-400">‚ñº</span>
                </button>
                <div id="about-panel" class="hidden px-6 py-4 bg-gray-50 border-t border-gray-200">
                    <p class="text-sm text-gray-700 mb-3">
                        This dashboard visualizes <strong>55,367 wildfire incidents</strong> across the United States from <strong>1991-2015</strong>.
                        Data combines fire incident reports from the U.S. Forest Service with weather data from NOAA weather stations
                        and vegetation classifications from USGS land cover datasets.
                    </p>
                    <p class="text-sm text-gray-700 mb-3">
                        <strong>Data Sources:</strong>
                    </p>
                    <ul class="text-sm text-gray-700 list-disc list-inside space-y-1 mb-3">
                        <li>Fire incidents: U.S. Forest Service Fire Program Analysis</li>
                        <li>Weather data: NOAA Integrated Surface Database (ISD)</li>
                        <li>Vegetation: USGS Land Cover Classification (28 types)</li>
                    </ul>
                    <p class="text-sm text-gray-600 italic">
                        <strong>Limitations:</strong> 25.7% of records have missing weather data. Only 46.3% include containment dates.
                        Some fire size classifications may contain data quality issues.
                    </p>
                </div>
            </div>

            <!-- How to Use -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button onclick="togglePanel('howto-panel')" class="w-full px-6 py-3 text-left font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center">
                    <span>üìñ How to Use This Dashboard</span>
                    <span id="howto-icon" class="text-gray-400">‚ñº</span>
                </button>
                <div id="howto-panel" class="hidden px-6 py-4 bg-gray-50 border-t border-gray-200">
                    <ol class="text-sm text-gray-700 list-decimal list-inside space-y-2">
                        <li><strong>Filter the data:</strong> Use the dropdowns and sliders at the top to focus on specific states, time periods, or fire causes.</li>
                        <li><strong>Explore visualizations:</strong> Hover over charts for detailed information. Click elements to filter (e.g., click a state on the map).</li>
                        <li><strong>Download charts:</strong> Click the "üì∑ Save" button on any chart to download it as a PNG image for reports or presentations.</li>
                        <li><strong>Reset filters:</strong> Click "Reset All Filters" to return to the full dataset.</li>
                        <li><strong>Look for patterns:</strong> Notice when fires occur most (spring peak), where (southern states), and why (human causes dominate).</li>
                    </ol>
                </div>
            </div>

            <!-- Fire Size Classes -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button onclick="togglePanel('classes-panel')" class="w-full px-6 py-3 text-left font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center">
                    <span>üìè Understanding Fire Size Classes</span>
                    <span id="classes-icon" class="text-gray-400">‚ñº</span>
                </button>
                <div id="classes-panel" class="hidden px-6 py-4 bg-gray-50 border-t border-gray-200">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div class="bg-green-50 p-3 rounded border-l-4 border-green-500">
                            <div class="font-bold text-green-700">Class A</div>
                            <div class="text-gray-600">0 - 0.25 acres</div>
                        </div>
                        <div class="bg-yellow-50 p-3 rounded border-l-4 border-yellow-500">
                            <div class="font-bold text-yellow-700">Class B</div>
                            <div class="text-gray-600">0.26 - 9.9 acres</div>
                        </div>
                        <div class="bg-orange-50 p-3 rounded border-l-4 border-orange-500">
                            <div class="font-bold text-orange-700">Class C</div>
                            <div class="text-gray-600">10 - 99.9 acres</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded border-l-4 border-red-400">
                            <div class="font-bold text-red-700">Class D</div>
                            <div class="text-gray-600">100 - 299 acres</div>
                        </div>
                        <div class="bg-red-100 p-3 rounded border-l-4 border-red-500">
                            <div class="font-bold text-red-800">Class E</div>
                            <div class="text-gray-600">300 - 999 acres</div>
                        </div>
                        <div class="bg-red-200 p-3 rounded border-l-4 border-red-600">
                            <div class="font-bold text-red-900">Class F</div>
                            <div class="text-gray-600">1,000 - 4,999 acres</div>
                        </div>
                        <div class="bg-red-300 p-3 rounded border-l-4 border-red-700">
                            <div class="font-bold text-red-900">Class G</div>
                            <div class="text-gray-600">5,000+ acres</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded border-l-4 border-gray-400 flex items-center">
                            <div class="text-xs text-gray-600">Most fires are Class B. Class G fires are rare but burn millions of acres.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fire Prevention -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <button onclick="togglePanel('prevention-panel')" class="w-full px-6 py-3 text-left font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center">
                    <span>üî• Fire Prevention Tips</span>
                    <span id="prevention-icon" class="text-gray-400">‚ñº</span>
                </button>
                <div id="prevention-panel" class="hidden px-6 py-4 bg-gray-50 border-t border-gray-200">
                    <p class="text-sm text-gray-700 mb-3">
                        <strong>70% of wildfires are caused by humans and are preventable!</strong> Here's how you can help:
                    </p>
                    <div class="grid md:grid-cols-2 gap-4 text-sm text-gray-700">
                        <div>
                            <h4 class="font-semibold mb-2">üèïÔ∏è Campfire Safety</h4>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Never leave campfires unattended</li>
                                <li>Drown fires with water before leaving</li>
                                <li>Build fires in designated areas only</li>
                                <li>Keep fires small and manageable</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">üî• Debris Burning</h4>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Check for local burn bans first</li>
                                <li>Clear area around burn pile</li>
                                <li>Have water and tools ready</li>
                                <li>Never burn on windy days</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">üöó Vehicle & Equipment</h4>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Don't park on dry grass</li>
                                <li>Maintain equipment to prevent sparks</li>
                                <li>Use spark arresters on equipment</li>
                                <li>Avoid using power tools in dry conditions</li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold mb-2">üë®‚Äçüë©‚Äçüëß General Safety</h4>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Teach children about fire danger</li>
                                <li>Dispose of cigarettes properly</li>
                                <li>Report suspicious activity</li>
                                <li>Follow Smokey Bear: "Only YOU can prevent wildfires!"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualizations -->
        <div id="visualizations">
            <!-- Row 1: Weather & Fire Risk -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üå°Ô∏è Weather & Fire Risk</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Temperature Chart -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Temperature Before Fires</h3>
                            <button onclick="downloadChart('temp-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                                üì∑ Save
                            </button>
                        </div>
                        <div id="temp-chart" style="height: 350px;"></div>
                        <div class="mt-2 text-xs text-gray-500">
                            ‚ö†Ô∏è Based on fires with complete weather data
                        </div>
                    </div>

                    <!-- Humidity/Precipitation Chart -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Humidity & Precipitation</h3>
                            <button onclick="downloadChart('humidity-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                                üì∑ Save
                            </button>
                        </div>
                        <div id="humidity-chart" style="height: 350px;"></div>
                        <div class="mt-2 text-xs text-gray-500">
                            Blue bars: Humidity (%), Green line: Precipitation (mm)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: When Fires Strike -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üìÖ When Fires Strike</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Seasonal Heatmap -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Seasonal Patterns</h3>
                            <button onclick="downloadChart('heatmap-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                                üì∑ Save
                            </button>
                        </div>
                        <div id="heatmap-chart" style="height: 500px;"></div>
                        <div class="mt-2 text-xs text-gray-500">
                            Darker red = more fires. Click to explore specific periods.
                        </div>
                    </div>

                    <!-- Year-over-Year Trends -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Year-over-Year Trends</h3>
                            <button onclick="downloadChart('trends-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                                üì∑ Save
                            </button>
                        </div>
                        <div id="trends-chart" style="height: 500px;"></div>
                        <div class="mt-2 text-xs text-gray-500">
                            Shows fire counts by year. Separate lines for top causes.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 3: Fire Causes & Characteristics -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üî• Fire Causes & Characteristics</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Cause Breakdown -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">What Starts Fires?</h3>
                            <button onclick="downloadChart('cause-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                                üì∑ Save
                            </button>
                        </div>
                        <div id="cause-chart" style="height: 400px;"></div>
                        <div class="mt-2 text-sm text-gray-600 bg-yellow-50 p-3 rounded border-l-4 border-yellow-400">
                            <strong>Prevention Tip:</strong> <span id="prevention-tip">Most fires are human-caused and preventable!</span>
                        </div>
                    </div>

                    <!-- Fire Size Distribution -->
                    <div class="chart-container">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-lg font-semibold text-gray-700">Fire Size Distribution</h3>
                            <button onclick="downloadChart('size-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                                üì∑ Save
                            </button>
                        </div>
                        <div id="size-chart" style="height: 400px;"></div>
                        <div class="mt-2 text-xs text-gray-500">
                            Most fires are small (Class A-B), but large fires (F-G) burn the most acres.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 4: Geographic Overview -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">üó∫Ô∏è Geographic Overview</h2>
                <div class="chart-container">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gray-700">U.S. Fire Density by State</h3>
                        <button onclick="downloadChart('map-chart')" class="text-sm text-blue-600 hover:text-blue-800">
                            üì∑ Save
                        </button>
                    </div>
                    <div id="map-chart" style="height: 500px;"></div>
                    <div class="mt-2 text-xs text-gray-500">
                        Click a state to filter entire dashboard to that region.
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 mb-6 text-center text-sm text-gray-600" role="contentinfo">
            <div class="border-t border-gray-300 pt-6">
                <p class="mb-2">
                    <strong>SMOKEY Wildfire Dashboard</strong> | Data: 1991-2015 | 55,367 wildfire incidents
                </p>
                <p class="mb-2">
                    Data loaded from: <a href="https://github.com/varunr89/smokey" class="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">GitHub Repository</a>
                </p>
                <p class="mb-2">
                    Sources: U.S. Forest Service, NOAA, USGS
                </p>
                <p class="text-xs text-gray-500">
                    Dashboard built with Plotly.js, PapaParse, and Tailwind CSS.
                    <br>
                    Remember: <em>"Only YOU can prevent wildfires!"</em> - Smokey Bear
                </p>
            </div>
        </footer>
    </div>

    <script>
        // Global data storage
        let rawData = [];
        let filteredData = [];

        // Filter state
        let currentFilters = {
            state: 'all',
            region: 'all',
            yearMin: 1991,
            yearMax: 2015,
            cause: 'all',
            sizeClass: 'all'
        };

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const icon = document.getElementById(panelId.replace('-panel', '-icon'));

            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                icon.textContent = '‚ñ≤';
            } else {
                panel.classList.add('hidden');
                icon.textContent = '‚ñº';
            }
        }

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function initializeYearSliders() {
            const minSlider = document.getElementById('filter-year-min');
            const maxSlider = document.getElementById('filter-year-max');
            const label = document.getElementById('year-range-label');

            const updateYearRange = debounce(() => {
                let minYear = parseInt(minSlider.value);
                let maxYear = parseInt(maxSlider.value);

                // Ensure min doesn't exceed max
                if (minYear > maxYear) {
                    minYear = maxYear;
                    minSlider.value = minYear;
                }

                // Ensure max doesn't go below min
                if (maxYear < minYear) {
                    maxYear = minYear;
                    maxSlider.value = maxYear;
                }

                currentFilters.yearMin = minYear;
                currentFilters.yearMax = maxYear;
                label.textContent = `${minYear} - ${maxYear}`;

                updateFilteredData();
            }, 300);

            minSlider.addEventListener('input', updateYearRange);
            maxSlider.addEventListener('input', updateYearRange);
        }

        function initializeFilters() {
            // Populate state dropdown
            const states = [...new Set(filteredData.map(r => r.state))].sort();
            const stateSelect = document.getElementById('filter-state');
            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelect.appendChild(option);
            });

            // Populate cause dropdown
            const causes = [...new Set(filteredData.map(r => r.stat_cause_descr))].filter(c => c).sort();
            const causeSelect = document.getElementById('filter-cause');
            causeSelect.innerHTML = '<option value="all">All Causes</option>';
            causeSelect.innerHTML += '<option value="human">Human-Caused</option>';
            causeSelect.innerHTML += '<option value="natural">Natural (Lightning)</option>';
            causeSelect.innerHTML += '<option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>';
            causes.forEach(cause => {
                const option = document.createElement('option');
                option.value = cause;
                option.textContent = cause;
                causeSelect.appendChild(option);
            });

            // Populate size class dropdown
            const sizeSelect = document.getElementById('filter-size');
            ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = `Class ${size}`;
                sizeSelect.appendChild(option);
            });

            // Add event listeners
            document.getElementById('filter-state').addEventListener('change', handleFilterChange);
            document.getElementById('filter-region').addEventListener('change', handleFilterChange);
            document.getElementById('filter-cause').addEventListener('change', handleFilterChange);
            document.getElementById('filter-size').addEventListener('change', handleFilterChange);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);

            // Initialize year sliders
            initializeYearSliders();

            // Initial update
            updateFilteredData();
        }

        function handleFilterChange(event) {
            const filterId = event.target.id.replace('filter-', '');

            if (filterId === 'state') {
                currentFilters.state = event.target.value;
                // Reset region if state selected
                if (currentFilters.state !== 'all') {
                    currentFilters.region = 'all';
                    document.getElementById('filter-region').value = 'all';
                }
            } else if (filterId === 'region') {
                currentFilters.region = event.target.value;
                // Reset state if region selected
                if (currentFilters.region !== 'all') {
                    currentFilters.state = 'all';
                    document.getElementById('filter-state').value = 'all';
                }
            } else if (filterId === 'cause') {
                currentFilters.cause = event.target.value;
            } else if (filterId === 'size') {
                currentFilters.sizeClass = event.target.value;
            }

            updateFilteredData();
        }

        function updateFilteredData() {
            let data = [...filteredData];

            // Apply state filter
            if (currentFilters.state !== 'all') {
                data = data.filter(r => r.state === currentFilters.state);
            }

            // Apply region filter
            if (currentFilters.region !== 'all') {
                data = data.filter(r => r.region === currentFilters.region);
            }

            // Apply cause filter
            if (currentFilters.cause === 'human') {
                data = data.filter(r => r.is_human_caused);
            } else if (currentFilters.cause === 'natural') {
                data = data.filter(r => r.stat_cause_descr === 'Lightning');
            } else if (currentFilters.cause !== 'all') {
                data = data.filter(r => r.stat_cause_descr === currentFilters.cause);
            }

            // Apply size class filter
            if (currentFilters.sizeClass !== 'all') {
                data = data.filter(r => r.fire_size_class === currentFilters.sizeClass);
            }

            // Apply year range filter
            data = data.filter(r => r.disc_pre_year >= currentFilters.yearMin && r.disc_pre_year <= currentFilters.yearMax);

            // Update display
            document.getElementById('record-count').textContent = data.toLocaleString();

            // Render all charts with filtered data
            renderAllCharts();
        }

        function resetFilters() {
            currentFilters = {
                state: 'all',
                region: 'all',
                yearMin: 1991,
                yearMax: 2015,
                cause: 'all',
                sizeClass: 'all'
            };

            document.getElementById('filter-state').value = 'all';
            document.getElementById('filter-region').value = 'all';
            document.getElementById('filter-cause').value = 'all';
            document.getElementById('filter-size').value = 'all';
            document.getElementById('filter-year-min').value = 1991;
            document.getElementById('filter-year-max').value = 2015;
            document.getElementById('year-range-label').textContent = '1991 - 2015';

            updateFilteredData();
        }

        function renderTemperatureChart(data) {
            // Filter data with valid temperature readings
            const validData = data.filter(r =>
                r.Temp_pre_30 !== null &&
                r.Temp_pre_15 !== null &&
                r.Temp_pre_7 !== null &&
                r.Temp_cont !== null
            );

            // Group by fire size class
            const sizeClasses = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
            const traces = [];

            sizeClasses.forEach(sizeClass => {
                const classData = validData.filter(r => r.fire_size_class === sizeClass);

                if (classData.length === 0) return;

                // Calculate averages for each time window
                const avgTemp30 = classData.reduce((sum, r) => sum + r.Temp_pre_30, 0) / classData.length;
                const avgTemp15 = classData.reduce((sum, r) => sum + r.Temp_pre_15, 0) / classData.length;
                const avgTemp7 = classData.reduce((sum, r) => sum + r.Temp_pre_7, 0) / classData.length;
                const avgTempCont = classData.reduce((sum, r) => sum + r.Temp_cont, 0) / classData.length;

                traces.push({
                    x: ['-30 days', '-15 days', '-7 days', 'Containment'],
                    y: [avgTemp30, avgTemp15, avgTemp7, avgTempCont],
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Class ${sizeClass} (${classData.length})`,
                    line: { width: 2 },
                    marker: { size: 8 }
                });
            });

            const layout = {
                xaxis: {
                    title: 'Time Window',
                    showgrid: true
                },
                yaxis: {
                    title: 'Average Temperature (¬∞C)',
                    showgrid: true
                },
                hovermode: 'closest',
                showlegend: true,
                legend: {
                    x: 1,
                    xanchor: 'right',
                    y: 1
                },
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('temp-chart', traces, layout, config);
        }

        function renderHumidityPrecipChart(data) {
            // Filter data with valid humidity and precipitation readings
            const validData = data.filter(r =>
                r.Hum_pre_30 !== null && r.Hum_pre_15 !== null && r.Hum_pre_7 !== null && r.Hum_cont !== null &&
                r.Prec_pre_30 !== null && r.Prec_pre_15 !== null && r.Prec_pre_7 !== null && r.Prec_cont !== null
            );

            if (validData.length === 0) {
                document.getElementById('humidity-chart').innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-400">No data with complete weather records</div>';
                return;
            }

            // Calculate averages
            const avgHum30 = validData.reduce((sum, r) => sum + r.Hum_pre_30, 0) / validData.length;
            const avgHum15 = validData.reduce((sum, r) => sum + r.Hum_pre_15, 0) / validData.length;
            const avgHum7 = validData.reduce((sum, r) => sum + r.Hum_pre_7, 0) / validData.length;
            const avgHumCont = validData.reduce((sum, r) => sum + r.Hum_cont, 0) / validData.length;

            const avgPrec30 = validData.reduce((sum, r) => sum + r.Prec_pre_30, 0) / validData.length;
            const avgPrec15 = validData.reduce((sum, r) => sum + r.Prec_pre_15, 0) / validData.length;
            const avgPrec7 = validData.reduce((sum, r) => sum + r.Prec_pre_7, 0) / validData.length;
            const avgPrecCont = validData.reduce((sum, r) => sum + r.Prec_cont, 0) / validData.length;

            const timeWindows = ['-30 days', '-15 days', '-7 days', 'Containment'];

            // Humidity bars
            const humidityTrace = {
                x: timeWindows,
                y: [avgHum30, avgHum15, avgHum7, avgHumCont],
                type: 'bar',
                name: 'Humidity (%)',
                marker: {
                    color: 'rgba(54, 162, 235, 0.7)',
                    line: { color: 'rgba(54, 162, 235, 1)', width: 2 }
                },
                yaxis: 'y'
            };

            // Precipitation line
            const precipTrace = {
                x: timeWindows,
                y: [avgPrec30, avgPrec15, avgPrec7, avgPrecCont],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Precipitation (mm)',
                line: { color: 'rgba(75, 192, 192, 1)', width: 3 },
                marker: { size: 10, color: 'rgba(75, 192, 192, 1)' },
                yaxis: 'y2'
            };

            const layout = {
                xaxis: {
                    title: 'Time Window',
                    showgrid: true
                },
                yaxis: {
                    title: 'Humidity (%)',
                    titlefont: { color: 'rgba(54, 162, 235, 1)' },
                    tickfont: { color: 'rgba(54, 162, 235, 1)' },
                    showgrid: true,
                    range: [0, 100]
                },
                yaxis2: {
                    title: 'Precipitation (mm)',
                    titlefont: { color: 'rgba(75, 192, 192, 1)' },
                    tickfont: { color: 'rgba(75, 192, 192, 1)' },
                    overlaying: 'y',
                    side: 'right',
                    showgrid: false
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: { x: 0, y: 1.1, orientation: 'h' },
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('humidity-chart', [humidityTrace, precipTrace], layout, config);
        }

        function downloadChart(chartId) {
            Plotly.downloadImage(chartId, {
                format: 'png',
                width: 1200,
                height: 600,
                filename: `smokey-${chartId}`
            });
        }

        function renderSeasonalHeatmap(data) {
            // Create matrix: years (y) x months (x)
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const years = [];
            for (let y = 1991; y <= 2015; y++) {
                years.push(y);
            }

            // Count fires for each month-year combination
            const matrix = [];
            const counts = {};

            data.forEach(row => {
                const year = row.disc_pre_year;
                const month = row.discovery_month;
                const key = `${year}-${month}`;
                counts[key] = (counts[key] || 0) + 1;
            });

            // Build matrix (years as rows, months as columns)
            years.forEach(year => {
                const row = [];
                months.forEach(month => {
                    const key = `${year}-${month}`;
                    row.push(counts[key] || 0);
                });
                matrix.push(row);
            });

            const trace = {
                z: matrix,
                x: months,
                y: years,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgb(255, 255, 255)'],
                    [0.2, 'rgb(255, 237, 160)'],
                    [0.4, 'rgb(254, 178, 76)'],
                    [0.6, 'rgb(253, 141, 60)'],
                    [0.8, 'rgb(240, 59, 32)'],
                    [1, 'rgb(189, 0, 38)']
                ],
                colorbar: {
                    title: 'Fire Count',
                    thickness: 15
                },
                hovertemplate: '<b>%{y} %{x}</b><br>Fires: %{z}<extra></extra>'
            };

            const layout = {
                xaxis: {
                    title: 'Month',
                    side: 'bottom',
                    tickmode: 'linear'
                },
                yaxis: {
                    title: 'Year',
                    autorange: 'reversed',
                    tickmode: 'linear',
                    dtick: 2
                },
                margin: { l: 60, r: 50, t: 20, b: 60 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'zoom2d']
            };

            Plotly.newPlot('heatmap-chart', [trace], layout, config);
        }

        function renderYearlyTrends(data) {
            // Count total fires per year
            const yearCounts = {};
            const causeCounts = {};

            data.forEach(row => {
                const year = row.disc_pre_year;
                yearCounts[year] = (yearCounts[year] || 0) + 1;

                const cause = row.stat_cause_descr || 'Unknown';
                if (!causeCounts[cause]) {
                    causeCounts[cause] = {};
                }
                causeCounts[cause][year] = (causeCounts[cause][year] || 0) + 1;
            });

            // Get top 5 causes by total count
            const topCauses = Object.entries(causeCounts)
                .map(([cause, years]) => ({
                    cause,
                    total: Object.values(years).reduce((a, b) => a + b, 0)
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 5)
                .map(c => c.cause);

            const years = [];
            for (let y = 1991; y <= 2015; y++) {
                years.push(y);
            }

            const traces = [];

            // Total fires trace
            traces.push({
                x: years,
                y: years.map(y => yearCounts[y] || 0),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Total Fires',
                line: { width: 3, color: 'rgb(0, 0, 0)' },
                marker: { size: 6 }
            });

            // Top causes traces
            const colors = [
                'rgb(255, 99, 71)',   // Red
                'rgb(255, 159, 64)',  // Orange
                'rgb(75, 192, 192)',  // Teal
                'rgb(54, 162, 235)',  // Blue
                'rgb(153, 102, 255)'  // Purple
            ];

            topCauses.forEach((cause, idx) => {
                traces.push({
                    x: years,
                    y: years.map(y => causeCounts[cause][y] || 0),
                    type: 'scatter',
                    mode: 'lines',
                    name: cause,
                    line: { width: 2, color: colors[idx] },
                    visible: 'legendonly'  // Hidden by default, click to show
                });
            });

            const layout = {
                xaxis: {
                    title: 'Year',
                    showgrid: true,
                    dtick: 2
                },
                yaxis: {
                    title: 'Number of Fires',
                    showgrid: true
                },
                hovermode: 'x unified',
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.8)'
                },
                margin: { l: 60, r: 30, t: 20, b: 60 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('trends-chart', traces, layout, config);
        }

        function renderCauseDonut(data) {
            // Count fires by cause
            const causeCounts = {};
            data.forEach(row => {
                const cause = row.stat_cause_descr || 'Unknown';
                causeCounts[cause] = (causeCounts[cause] || 0) + 1;
            });

            // Sort by count
            const sortedCauses = Object.entries(causeCounts)
                .sort((a, b) => b[1] - a[1]);

            const labels = sortedCauses.map(c => c[0]);
            const values = sortedCauses.map(c => c[1]);

            // Color by human vs natural
            const colors = labels.map(cause => {
                const humanCauses = ['Arson', 'Debris Burning', 'Equipment Use', 'Campfire',
                                    'Children', 'Smoking', 'Fireworks', 'Railroad', 'Powerline', 'Structure'];
                if (humanCauses.includes(cause)) {
                    return 'rgba(255, 99, 71, 0.8)';  // Red for human
                } else if (cause === 'Lightning') {
                    return 'rgba(54, 162, 235, 0.8)';  // Blue for natural
                } else {
                    return 'rgba(150, 150, 150, 0.8)';  // Gray for unknown
                }
            });

            const trace = {
                labels: labels,
                values: values,
                type: 'pie',
                hole: 0.4,  // Donut hole
                marker: {
                    colors: colors,
                    line: { color: 'white', width: 2 }
                },
                textposition: 'outside',
                textinfo: 'label+percent',
                hovertemplate: '<b>%{label}</b><br>Count: %{value}<br>Percentage: %{percent}<extra></extra>'
            };

            // Calculate human vs natural percentage
            const humanCount = data.filter(r => r.is_human_caused).length;
            const humanPercent = ((humanCount / data.length) * 100).toFixed(1);

            const layout = {
                annotations: [{
                    text: `${humanPercent}%<br>Human<br>Caused`,
                    x: 0.5,
                    y: 0.5,
                    font: { size: 18, color: 'rgb(255, 99, 71)' },
                    showarrow: false
                }],
                showlegend: true,
                legend: {
                    orientation: 'v',
                    x: 1.1,
                    y: 0.5
                },
                margin: { l: 20, r: 150, t: 20, b: 20 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'zoom2d']
            };

            Plotly.newPlot('cause-chart', [trace], layout, config);

            // Update prevention tip
            updatePreventionTip(sortedCauses[0][0]);
        }

        function updatePreventionTip(topCause) {
            const tips = {
                'Debris Burning': 'Check local burn bans before burning debris. Keep fires small and attended.',
                'Arson': 'Report suspicious activity. Arson is a crime with serious consequences.',
                'Lightning': 'Natural fires are part of ecosystem cycles, but stay alert during dry storms.',
                'Miscellaneous': 'Stay aware of fire conditions and follow local fire safety guidelines.',
                'Equipment Use': 'Maintain equipment properly. Avoid using spark-producing tools in dry conditions.',
                'Campfire': 'Never leave campfires unattended. Drown fires completely before leaving.',
                'Children': 'Teach children about fire safety. Keep matches and lighters out of reach.',
                'Smoking': 'Dispose of cigarettes properly. Never throw lit cigarettes from vehicles.',
                'Railroad': 'Report track sparking and vegetation overgrowth near railways.',
                'Fireworks': 'Follow local fireworks laws. Use in clear areas away from dry vegetation.'
            };

            const tip = tips[topCause] || 'Most fires are human-caused and preventable!';
            document.getElementById('prevention-tip').textContent = tip;
        }

        function renderSizeHistogram(data) {
            // Get fire sizes (in acres)
            const sizes = data.map(r => r.fire_size).filter(s => s && s > 0);

            if (sizes.length === 0) {
                document.getElementById('size-chart').innerHTML =
                    '<div class="flex items-center justify-center h-full text-gray-400">No size data available</div>';
                return;
            }

            // Calculate statistics
            const mean = sizes.reduce((a, b) => a + b, 0) / sizes.length;
            const sorted = [...sizes].sort((a, b) => a - b);
            const median = sorted[Math.floor(sorted.length / 2)];
            const max = Math.max(...sizes);

            const trace = {
                x: sizes,
                type: 'histogram',
                nbinsx: 50,
                marker: {
                    color: 'rgba(255, 159, 64, 0.7)',
                    line: {
                        color: 'rgba(255, 159, 64, 1)',
                        width: 1
                    }
                },
                hovertemplate: 'Size Range: %{x}<br>Count: %{y}<extra></extra>'
            };

            const layout = {
                xaxis: {
                    title: 'Fire Size (acres)',
                    type: 'log',  // Logarithmic scale for wide range
                    showgrid: true
                },
                yaxis: {
                    title: 'Number of Fires',
                    showgrid: true
                },
                shapes: [
                    // Mean line
                    {
                        type: 'line',
                        x0: mean,
                        x1: mean,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'red',
                            width: 2,
                            dash: 'dash'
                        }
                    },
                    // Median line
                    {
                        type: 'line',
                        x0: median,
                        x1: median,
                        y0: 0,
                        y1: 1,
                        yref: 'paper',
                        line: {
                            color: 'blue',
                            width: 2,
                            dash: 'dot'
                        }
                    }
                ],
                annotations: [
                    {
                        x: mean,
                        y: 0.9,
                        yref: 'paper',
                        text: `Mean: ${mean.toFixed(1)} acres`,
                        showarrow: true,
                        arrowhead: 2,
                        ax: 40,
                        ay: -40,
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: 'red'
                    },
                    {
                        x: median,
                        y: 0.7,
                        yref: 'paper',
                        text: `Median: ${median.toFixed(1)} acres`,
                        showarrow: true,
                        arrowhead: 2,
                        ax: -40,
                        ay: -40,
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: 'blue'
                    }
                ],
                margin: { l: 60, r: 30, t: 20, b: 60 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            Plotly.newPlot('size-chart', [trace], layout, config);
        }

        function renderUSMap(data) {
            // Count fires by state
            const stateCounts = {};
            const stateData = {};

            data.forEach(row => {
                const state = row.state;
                if (!state) return;

                if (!stateCounts[state]) {
                    stateCounts[state] = 0;
                    stateData[state] = {
                        count: 0,
                        totalSize: 0,
                        causes: {}
                    };
                }

                stateCounts[state]++;
                stateData[state].count++;
                stateData[state].totalSize += (row.fire_size || 0);

                const cause = row.stat_cause_descr || 'Unknown';
                stateData[state].causes[cause] = (stateData[state].causes[cause] || 0) + 1;
            });

            // Prepare data for choropleth
            const states = Object.keys(stateCounts);
            const counts = states.map(s => stateCounts[s]);

            // Get top cause per state
            const hoverText = states.map(state => {
                const info = stateData[state];
                const avgSize = info.totalSize / info.count;
                const topCause = Object.entries(info.causes)
                    .sort((a, b) => b[1] - a[1])[0][0];

                return `<b>${state}</b><br>` +
                       `Fires: ${info.count.toLocaleString()}<br>` +
                       `Avg Size: ${avgSize.toFixed(1)} acres<br>` +
                       `Top Cause: ${topCause}`;
            });

            const trace = {
                type: 'choropleth',
                locationmode: 'USA-states',
                locations: states,
                z: counts,
                text: hoverText,
                hovertemplate: '%{text}<extra></extra>',
                colorscale: [
                    [0, 'rgb(255, 255, 255)'],
                    [0.2, 'rgb(255, 237, 160)'],
                    [0.4, 'rgb(254, 178, 76)'],
                    [0.6, 'rgb(253, 141, 60)'],
                    [0.8, 'rgb(240, 59, 32)'],
                    [1, 'rgb(189, 0, 38)']
                ],
                colorbar: {
                    title: 'Fire<br>Count',
                    thickness: 15
                },
                marker: {
                    line: {
                        color: 'rgb(255, 255, 255)',
                        width: 2
                    }
                }
            };

            const layout = {
                geo: {
                    scope: 'usa',
                    projection: { type: 'albers usa' },
                    showlakes: true,
                    lakecolor: 'rgb(220, 240, 255)'
                },
                margin: { l: 0, r: 0, t: 0, b: 0 }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'zoom2d']
            };

            Plotly.newPlot('map-chart', [trace], layout, config);

            // Add click handler to filter by state
            document.getElementById('map-chart').on('plotly_click', function(eventData) {
                if (eventData.points.length > 0) {
                    const clickedState = eventData.points[0].location;
                    document.getElementById('filter-state').value = clickedState;
                    currentFilters.state = clickedState;
                    currentFilters.region = 'all';
                    document.getElementById('filter-region').value = 'all';
                    updateFilteredData();
                }
            });
        }

        function renderAllCharts() {
            const data = getFilteredData();
            renderTemperatureChart(data);
            renderHumidityPrecipChart(data);
            renderSeasonalHeatmap(data);
            renderYearlyTrends(data);
            renderCauseDonut(data);
            renderSizeHistogram(data);
            renderUSMap(data);
        }

        function getFilteredData() {
            let data = [...filteredData];

            // Apply all current filters
            if (currentFilters.state !== 'all') {
                data = data.filter(r => r.state === currentFilters.state);
            }
            if (currentFilters.region !== 'all') {
                data = data.filter(r => r.region === currentFilters.region);
            }
            if (currentFilters.cause === 'human') {
                data = data.filter(r => r.is_human_caused);
            } else if (currentFilters.cause === 'natural') {
                data = data.filter(r => r.stat_cause_descr === 'Lightning');
            } else if (currentFilters.cause !== 'all') {
                data = data.filter(r => r.stat_cause_descr === currentFilters.cause);
            }
            if (currentFilters.sizeClass !== 'all') {
                data = data.filter(r => r.fire_size_class === currentFilters.sizeClass);
            }
            data = data.filter(r => r.disc_pre_year >= currentFilters.yearMin && r.disc_pre_year <= currentFilters.yearMax);

            return data;
        }

        // Initialize dashboard
        async function initDashboard() {
            try {
                updateLoadingText('Loading wildfire data...', 'Fetching from GitHub (55K records)');
                await loadData();

                updateLoadingText('Processing data...', 'Cleaning and validating records');
                cleanData();

                updateLoadingText('Preparing visualizations...', 'Almost ready!');
                initializeFilters();

                // Initial chart render
                setTimeout(() => {
                    renderAllCharts();
                }, 100);

                // Hide loading, show dashboard
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                }, 500);

            } catch (error) {
                showError(error);
            }
        }

        function updateLoadingText(main, progress) {
            document.getElementById('loading-text').textContent = main;
            document.getElementById('loading-progress').textContent = progress;
        }

        function showError(error) {
            document.getElementById('loading').innerHTML = `
                <div class="text-center p-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Error Loading Data</h2>
                    <p class="text-gray-700 mb-4">${error.message}</p>
                    <div class="text-left bg-gray-50 p-4 rounded mb-4 border border-gray-200">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Possible solutions:</p>
                        <ul class="text-sm text-gray-600 list-disc list-inside space-y-1">
                            <li>Check your internet connection</li>
                            <li>Ensure GitHub is accessible from your network</li>
                            <li>If offline, download <code class="bg-gray-200 px-1 rounded">FW_Veg_Rem_Combined.csv</code> to the same folder</li>
                            <li>Try refreshing the page (Ctrl+R or Cmd+R)</li>
                        </ul>
                    </div>
                    <button onclick="location.reload()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600">
                        Retry
                    </button>
                </div>
            `;
        }

        async function loadData() {
            // Primary: GitHub raw URL
            const githubUrl = 'https://raw.githubusercontent.com/varunr89/smokey/master/FW_Veg_Rem_Combined.csv';
            // Fallback: Local file
            const localPath = 'FW_Veg_Rem_Combined.csv';

            return new Promise((resolve, reject) => {
                // Try GitHub first
                Papa.parse(githubUrl, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            rawData = results.data;
                            console.log(`‚úì Loaded ${rawData.length} records from GitHub`);
                            resolve();
                        } else {
                            console.warn('GitHub returned empty data, trying local file...');
                            tryLocalFile(resolve, reject);
                        }
                    },
                    error: function(error) {
                        console.warn('GitHub fetch failed:', error.message);
                        console.log('Attempting to load from local file...');
                        tryLocalFile(resolve, reject);
                    }
                });
            });

            function tryLocalFile(resolve, reject) {
                Papa.parse(localPath, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            rawData = results.data;
                            console.log(`‚úì Loaded ${rawData.length} records from local file`);
                            resolve();
                        } else {
                            reject(new Error('Both GitHub and local file loading failed.'));
                        }
                    },
                    error: function(error) {
                        reject(new Error('Could not load data from GitHub or local file. ' + error.message));
                    }
                });
            }
        }

        function cleanData() {
            // Filter out corrupted records and clean data
            filteredData = rawData.filter(row => {
                // Remove corrupted fire_size_class entries
                const validClasses = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
                if (!validClasses.includes(row.fire_size_class)) {
                    return false;
                }

                // Ensure basic required fields exist
                if (!row.state || !row.disc_pre_year) {
                    return false;
                }

                return true;
            });

            // Add derived fields
            filteredData.forEach(row => {
                // Map state to region
                row.region = getRegion(row.state);

                // Map month to season
                row.season = getSeason(row.discovery_month);

                // Classify as human vs natural
                row.is_human_caused = isHumanCaused(row.stat_cause_descr);

                // Handle missing weather data
                ['Temp_pre_30', 'Temp_pre_15', 'Temp_pre_7', 'Temp_cont',
                 'Wind_pre_30', 'Wind_pre_15', 'Wind_pre_7', 'Wind_cont',
                 'Hum_pre_30', 'Hum_pre_15', 'Hum_pre_7', 'Hum_cont',
                 'Prec_pre_30', 'Prec_pre_15', 'Prec_pre_7', 'Prec_cont'].forEach(field => {
                    if (row[field] === -1.0) {
                        row[field] = null;
                    }
                });
            });

            console.log(`Loaded ${filteredData.length} valid records`);
        }

        function getRegion(state) {
            const regions = {
                'West': ['WA', 'OR', 'CA', 'NV', 'ID', 'MT', 'WY', 'UT', 'CO', 'AZ', 'NM', 'AK', 'HI'],
                'Midwest': ['ND', 'SD', 'NE', 'KS', 'MN', 'IA', 'MO', 'WI', 'IL', 'MI', 'IN', 'OH'],
                'South': ['TX', 'OK', 'AR', 'LA', 'MS', 'AL', 'TN', 'KY', 'WV', 'VA', 'NC', 'SC', 'GA', 'FL', 'MD', 'DE', 'DC'],
                'Northeast': ['PA', 'NY', 'NJ', 'CT', 'RI', 'MA', 'VT', 'NH', 'ME']
            };

            for (let [region, states] of Object.entries(regions)) {
                if (states.includes(state)) return region;
            }
            return 'Other';
        }

        function getSeason(month) {
            const seasons = {
                'Winter': ['Dec', 'Jan', 'Feb'],
                'Spring': ['Mar', 'Apr', 'May'],
                'Summer': ['Jun', 'Jul', 'Aug'],
                'Fall': ['Sep', 'Oct', 'Nov']
            };

            for (let [season, months] of Object.entries(seasons)) {
                if (months.includes(month)) return season;
            }
            return 'Unknown';
        }

        function isHumanCaused(cause) {
            const humanCauses = ['Arson', 'Debris Burning', 'Equipment Use', 'Campfire',
                                'Children', 'Smoking', 'Fireworks', 'Railroad', 'Powerline', 'Structure'];
            return humanCauses.includes(cause);
        }

        // Start the dashboard
        initDashboard();
    </script>
</body>
</html>
